name: Sync and Generate Manifests

on:
  push:
    branches:
      - main
      - master
      - develop
    paths:
      - 'catalogs/**'
      - 'cortex/**'
      - 'thehive/**'
      - 'docs/vendors/**'
      - 'generate-manifest.py'
      - '.github/workflows/generate-manifests.yml'
  schedule:
    - cron: '0 2 * * *'      # Daily at 2 AM UTC
  workflow_dispatch:          # Allow manual trigger

# Prevent concurrent runs to avoid conflicts
concurrency:
  group: sync-and-generate
  cancel-in-progress: false

jobs:
  sync-and-generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Checkout Cortex-Analyzers upstream
        uses: actions/checkout@v4
        with:
          repository: TheHive-Project/Cortex-Analyzers
          path: upstream-cortex-analyzers
          fetch-depth: 1

      - name: Sync Cortex analyzer and responder configs
        run: |
          # Define tracked vendors (easy to expand later)
          VENDORS=("CrowdstrikeFalcon" "Proofpoint" "Slack")

          echo "### Syncing from Cortex-Analyzers" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Initialize counters
          total_added=0
          total_updated=0
          total_deleted=0
          total_invalid=0

          # Clean up local vendor directories not in tracked list or deleted from upstream
          for type in analyzers responders; do
            if [ -d "cortex/$type" ]; then
              for local_vendor_dir in cortex/$type/*/; do
                if [ -d "$local_vendor_dir" ]; then
                  vendor=$(basename "$local_vendor_dir")
                  # Check if vendor is in tracked list
                  if [[ ! " ${VENDORS[@]} " =~ " ${vendor} " ]]; then
                    rm -rf "$local_vendor_dir"
                    echo "ðŸ—‘ï¸ Removed untracked vendor directory: $type/$vendor" >> $GITHUB_STEP_SUMMARY
                    continue
                  fi
                  # Check if vendor still exists upstream
                  if [ ! -d "upstream-cortex-analyzers/$type/$vendor" ]; then
                    rm -rf "$local_vendor_dir"
                    echo "ðŸ—‘ï¸ Removed vendor directory: $type/$vendor (deleted from upstream)" >> $GITHUB_STEP_SUMMARY
                  fi
                fi
              done
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY

          for vendor in "${VENDORS[@]}"; do
            echo "Processing vendor: $vendor"

            # Sync analyzers
            if [ -d "upstream-cortex-analyzers/analyzers/$vendor" ]; then
              mkdir -p "cortex/analyzers/$vendor"

              added=0
              updated=0
              deleted=0

              # Delete local JSON files that don't exist upstream
              if [ -d "cortex/analyzers/$vendor" ]; then
                for local_file in cortex/analyzers/$vendor/*.json; do
                  if [ -f "$local_file" ]; then
                    filename=$(basename "$local_file")
                    if [ ! -f "upstream-cortex-analyzers/analyzers/$vendor/$filename" ]; then
                      rm "$local_file"
                      echo "  ðŸ—‘ï¸ Deleted: $filename" >> $GITHUB_STEP_SUMMARY
                      ((deleted++))
                      ((total_deleted++))
                    fi
                  fi
                done
              fi

              # Copy upstream files and track changes
              for upstream_file in upstream-cortex-analyzers/analyzers/$vendor/*.json; do
                if [ -f "$upstream_file" ]; then
                  filename=$(basename "$upstream_file")
                  local_file="cortex/analyzers/$vendor/$filename"

                  if [ -f "$local_file" ]; then
                    # File exists, check if it changed
                    if ! cmp -s "$upstream_file" "$local_file"; then
                      ((updated++))
                      ((total_updated++))
                    fi
                  else
                    # New file
                    ((added++))
                    ((total_added++))
                  fi

                  cp "$upstream_file" "$local_file"

                  # Validate JSON
                  if ! python -c "import json; json.load(open('$local_file'))" 2>/dev/null; then
                    echo "  âš ï¸ Invalid JSON: $filename" >> $GITHUB_STEP_SUMMARY
                    ((total_invalid++))
                  fi
                fi
              done

              # Summary for this vendor's analyzers
              if [ $added -gt 0 ] || [ $updated -gt 0 ] || [ $deleted -gt 0 ]; then
                echo "**Analyzers - $vendor:** +$added ~$updated -$deleted" >> $GITHUB_STEP_SUMMARY
              else
                echo "**Analyzers - $vendor:** No changes" >> $GITHUB_STEP_SUMMARY
              fi
            fi

            # Sync responders
            if [ -d "upstream-cortex-analyzers/responders/$vendor" ]; then
              mkdir -p "cortex/responders/$vendor"

              added=0
              updated=0
              deleted=0

              # Delete local JSON files that don't exist upstream
              if [ -d "cortex/responders/$vendor" ]; then
                for local_file in cortex/responders/$vendor/*.json; do
                  if [ -f "$local_file" ]; then
                    filename=$(basename "$local_file")
                    if [ ! -f "upstream-cortex-analyzers/responders/$vendor/$filename" ]; then
                      rm "$local_file"
                      echo "  ðŸ—‘ï¸ Deleted: $filename" >> $GITHUB_STEP_SUMMARY
                      ((deleted++))
                      ((total_deleted++))
                    fi
                  fi
                done
              fi

              # Copy upstream files and track changes
              for upstream_file in upstream-cortex-analyzers/responders/$vendor/*.json; do
                if [ -f "$upstream_file" ]; then
                  filename=$(basename "$upstream_file")
                  local_file="cortex/responders/$vendor/$filename"

                  if [ -f "$local_file" ]; then
                    # File exists, check if it changed
                    if ! cmp -s "$upstream_file" "$local_file"; then
                      ((updated++))
                      ((total_updated++))
                    fi
                  else
                    # New file
                    ((added++))
                    ((total_added++))
                  fi

                  cp "$upstream_file" "$local_file"

                  # Validate JSON
                  if ! python -c "import json; json.load(open('$local_file'))" 2>/dev/null; then
                    echo "  âš ï¸ Invalid JSON: $filename" >> $GITHUB_STEP_SUMMARY
                    ((total_invalid++))
                  fi
                fi
              done

              # Summary for this vendor's responders
              if [ $added -gt 0 ] || [ $updated -gt 0 ] || [ $deleted -gt 0 ]; then
                echo "**Responders - $vendor:** +$added ~$updated -$deleted" >> $GITHUB_STEP_SUMMARY
              else
                echo "**Responders - $vendor:** No changes" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total:** $total_added added, $total_updated updated, $total_deleted deleted" >> $GITHUB_STEP_SUMMARY
          if [ $total_invalid -gt 0 ]; then
            echo "âš ï¸ **$total_invalid invalid JSON files detected**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Generate manifests
        run: python generate-manifest.py

      - name: Check for changes
        id: git-check
        run: |
          if [ -n "$(git status --porcelain cortex/ catalogs/)" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "### Changes detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            git status --short cortex/ catalogs/ >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "### No changes detected" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Commit and push if changed
        if: steps.git-check.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add cortex/ catalogs/
          git commit -m "Auto-sync Cortex configs and regenerate manifests [skip ci]

          - Synced analyzer/responder configs from Cortex-Analyzers
          - Regenerated integration manifests"
          git pull --rebase origin ${{ github.ref_name }}
          git push

      - name: Upload artifacts
        if: steps.git-check.outputs.changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: integration-manifests-${{ github.run_number }}
          path: |
            catalogs/*/manifest.json
            catalogs/*/manifest.yml
            catalogs/integration-manifest.json
            catalogs/integration-manifest.yml
          retention-days: 30
